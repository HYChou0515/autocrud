# AutoCRUD Web - Makefile
# å¸¸ç”¨é–‹ç™¼æŒ‡ä»¤

.PHONY: help build-gen gen dev dev-app dev-gen install clean test clean-app gen-app reset-app regen-app style publish

# é è¨­ç›®æ¨™ï¼šé¡¯ç¤ºå¹«åŠ©
help:
	@echo "AutoCRUD Web - å¸¸ç”¨æŒ‡ä»¤"
	@echo ""
	@echo "App ç®¡ç†ï¼ˆæ¨è–¦ï¼‰ï¼š"
	@echo "  make clean-app    - åˆªé™¤æ•´å€‹ app ç›®éŒ„"
	@echo "  make gen-app      - ç”¨ generator ç”Ÿæˆå…¨æ–°çš„ appï¼ˆéœ€å…ˆ build-genï¼‰"
	@echo "  make reset-app    - åˆªé™¤ + é‡æ–°ç”Ÿæˆ appï¼ˆå®Œæ•´é‡ç½®ï¼‰"
	@echo "  make regen-app    - å¾ AutoCRUD å¾Œç«¯é‡æ–°ç”Ÿæˆå‰ç«¯ä»£ç¢¼"
	@echo "  make dev-app      - å•Ÿå‹• app é–‹ç™¼æœå‹™å™¨"
	@echo ""
	@echo "é–‹ç™¼æµç¨‹ï¼š"
	@echo "  make install      - å®‰è£æ‰€æœ‰ä¾è³´"
	@echo "  make build-gen    - ç·¨è­¯ generator"
	@echo "  make gen          - é‡æ–°ç”Ÿæˆå‰ç«¯ä»£ç¢¼"
	@echo "  make dev          - å•Ÿå‹•é–‹ç™¼æœå‹™å™¨"
	@echo "  make style        - è‡ªå‹•ä¿®å¾© lint + æ ¼å¼åŒ–ï¼ˆcommit å‰åŸ·è¡Œï¼‰"
	@echo ""
	@echo "çµ„åˆæŒ‡ä»¤ï¼š"
	@echo "  make rebuild      - é‡æ–°ç·¨è­¯ generator + é‡æ–°ç”Ÿæˆä»£ç¢¼"
	@echo "  make reset        - æ¸…ç† + å®‰è£ + ç·¨è­¯ + ç”Ÿæˆ"
	@echo ""
	@echo "å…¶ä»–ï¼š"
	@echo "  make clean        - æ¸…ç†ç”Ÿæˆçš„æª”æ¡ˆ"
	@echo "  make test         - åŸ·è¡Œæ¸¬è©¦"

# å®‰è£ä¾è³´
install:
	@echo "ğŸ“¦ å®‰è£ generator ä¾è³´..."
	cd generator && pnpm install
	@echo "ğŸ“¦ å®‰è£ app ä¾è³´..."
	cd app && pnpm install
	@echo "âœ… å®‰è£å®Œæˆ"

# ç·¨è­¯ generator
build-gen:
	@echo "ğŸ”¨ ç·¨è­¯ generator..."
	cd generator && pnpm build
	@echo "âœ… Generator ç·¨è­¯å®Œæˆ"

# é‡æ–°ç”Ÿæˆå‰ç«¯ä»£ç¢¼
gen:
	@echo "ğŸš€ é‡æ–°ç”Ÿæˆå‰ç«¯ä»£ç¢¼..."
	cd app && rm -rf src/generated
	cd app && node ../generator/dist/cli.js generate
	@echo "âœ… ä»£ç¢¼ç”Ÿæˆå®Œæˆ"

# å•Ÿå‹•é–‹ç™¼æœå‹™å™¨
dev:
	@echo "ğŸš€ å•Ÿå‹•é–‹ç™¼æœå‹™å™¨ (port 5175)..."
	cd app && pnpm dev --port 5175

# å•Ÿå‹•é–‹ç™¼æœå‹™å™¨ï¼ˆé è¨­ç«¯å£ï¼‰
dev-app:
	@echo "ğŸš€ å•Ÿå‹• app é–‹ç™¼æœå‹™å™¨..."
	cd app && pnpm dev

# çµ„åˆï¼šé‡æ–°ç·¨è­¯ + é‡æ–°ç”Ÿæˆ
rebuild: build-gen gen
	@echo "âœ… é‡æ–°ç·¨è­¯å’Œç”Ÿæˆå®Œæˆ"

# çµ„åˆï¼šå®Œæ•´é‡ç½®
reset: clean install build-gen gen
	@echo "âœ… å®Œæ•´é‡ç½®å®Œæˆï¼Œå¯ä»¥åŸ·è¡Œ 'make dev' å•Ÿå‹•"

# æ¸…ç†ç”Ÿæˆçš„æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æª”æ¡ˆ..."
	rm -rf generator/dist
	rm -rf generator/node_modules
	rm -rf app/src/generated
	rm -rf app/node_modules
	rm -rf app/dist
	@echo "âœ… æ¸…ç†å®Œæˆ"

# åŸ·è¡Œæ¸¬è©¦
test:
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	cd generator && pnpm test || echo "Generator æ²’æœ‰æ¸¬è©¦"
	cd app && pnpm test || echo "App æ²’æœ‰æ¸¬è©¦"

# Build production
build: build-gen
	@echo "ğŸ—ï¸  ç·¨è­¯ app ç”Ÿç”¢ç‰ˆæœ¬..."
	cd app && pnpm build
	@echo "âœ… ç”Ÿç”¢ç‰ˆæœ¬ç·¨è­¯å®Œæˆ"

# åŒæ­¥ app â†’ generator/templates/baseï¼ˆæ’é™¤è‡ªå‹•ç”Ÿæˆçš„æª”æ¡ˆï¼‰
sync-templates:
	@echo "ğŸ“‹ åŒæ­¥ app â†’ generator/templates/base..."
	rsync -av --delete \
		--exclude='node_modules' \
		--exclude='.vite' \
		--exclude='.tanstack' \
		--exclude='dist' \
		--exclude='.env' \
		--exclude='pnpm-lock.yaml' \
		--exclude='src/generated' \
		--exclude='src/routes/autocrud-admin' \
		--exclude='src/routeTree.gen.ts' \
		app/ generator/templates/base/
	@echo "âœ… Templates åŒæ­¥å®Œæˆ"

# ============================================================================
# App ç®¡ç†æŒ‡ä»¤
# ============================================================================

# åˆªé™¤æ•´å€‹ app ç›®éŒ„
clean-app:
	@echo "ğŸ”¥ åˆªé™¤ app ç›®éŒ„..."
	@if [ -d "app" ]; then \
		rm -rf app; \
		echo "âœ… app ç›®éŒ„å·²åˆªé™¤"; \
	else \
		echo "âš ï¸  app ç›®éŒ„ä¸å­˜åœ¨"; \
	fi

# ä½¿ç”¨ generator ç”Ÿæˆå…¨æ–°çš„ app
gen-app: build-gen
	@echo "ğŸš€ ä½¿ç”¨ generator ç”Ÿæˆå…¨æ–°çš„ app..."
	@if [ -d "app" ]; then \
		echo "âŒ Error: app ç›®éŒ„å·²å­˜åœ¨ï¼Œè«‹å…ˆåŸ·è¡Œ 'make clean-app'"; \
		exit 1; \
	fi
	@echo "ğŸ“‚ å¾æ¨¡æ¿å‰µå»ºæ–°çš„ app..."
	cd generator && node dist/cli.js init app --dir ..
	@echo "ğŸ“¦ å®‰è£ app ä¾è³´..."
	cd app && pnpm install
	@echo "ğŸ”§ å¾ AutoCRUD å¾Œç«¯ç”Ÿæˆä»£ç¢¼..."
	cd app && node ../generator/dist/cli.js generate --url http://0.0.0.0:8000
	@echo "âœ… App ç”Ÿæˆå®Œæˆï¼"
	@echo ""
	@echo "ğŸ“ ä¸‹ä¸€æ­¥ï¼š"
	@echo "   cd app"
	@echo "   pnpm dev"

# å®Œå…¨é‡ç½® appï¼šåˆªé™¤ + é‡æ–°ç”Ÿæˆ + å®‰è£ä¾è³´
reset-app: clean-app gen-app
	@echo "âœ… App å®Œå…¨é‡ç½®å®Œæˆï¼"

# å¾ AutoCRUD å¾Œç«¯ç”Ÿæˆå‰ç«¯ä»£ç¢¼
regen-app: build-gen
	@echo "ğŸš€ å¾ AutoCRUD å¾Œç«¯é‡æ–°ç”Ÿæˆå‰ç«¯ä»£ç¢¼..."
	@if [ ! -d "app" ]; then \
		echo "âŒ Error: app ç›®éŒ„ä¸å­˜åœ¨ï¼Œè«‹å…ˆåŸ·è¡Œ 'make gen-app'"; \
		exit 1; \
	fi
	@echo "ğŸ”§ æ¸…é™¤èˆŠçš„ç”Ÿæˆä»£ç¢¼..."
	rm -rf app/src/generated app/src/routes/autocrud-admin
	@echo "ğŸ“¡ é€£æ¥åˆ° http://0.0.0.0:8000..."
	cd app && node ../generator/dist/cli.js generate --url http://0.0.0.0:8000
	@echo "âœ… ä»£ç¢¼ç”Ÿæˆå®Œæˆ"

regen-and-run: regen-app dev-app
	@echo "âœ… é‡æ–°ç”Ÿæˆä¸¦å•Ÿå‹•å®Œæˆï¼"

# è‡ªå‹•ä¿®å¾© lint + æ ¼å¼åŒ–ï¼ˆcommit å‰åŸ·è¡Œä¸€æ¬¡å³å¯ï¼‰
style:
	@echo "ğŸ¨ Generator: lint --fix + prettier..."
	cd generator && pnpm lint:fix
	cd generator && pnpm format
	@echo "âœ… Style å®Œæˆ"

# ç™¼å¸ƒ generator åˆ° npmï¼ˆstyle + build + sync templates + publishï¼‰
publish: style sync-templates build-gen
	@echo "ğŸš€ ç™¼å¸ƒ generator åˆ° npm..."
	cd generator && pnpm check
	cd generator && npm publish
	@echo "âœ… ç™¼å¸ƒå®Œæˆ"